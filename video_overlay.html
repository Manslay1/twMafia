<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Twitch Extension Overlay</title>
    <script src="https://extension-files.twitch.tv/helper/v1/twitch-ext.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 10px 10px 10px 0;
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background-color: transparent;
            color: white;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            width: fit-content;
            max-width: 100%;
        }

        .title {
            font-size: 26px;
            margin-bottom: 10px;
            font-weight: bold;
            text-align: left;
            width: 100%;
        }

        .secondary-title {
            font-size: 24px;
            margin-top: 15px;
            margin-bottom: 10px;
            color: #a970ff;
            text-align: left;
            width: 100%;
        }

        .button-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: flex-start;
            width: 100%;
        }

        .button {
            background-color: rgba(145, 71, 255, 0.8);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 18px;
            transition: background-color 0.2s;
            white-space: nowrap;
        }

            .button:hover {
                background-color: rgba(119, 44, 232, 0.9);
            }
    </style>
</head>
<body>
    <div id="main-title" class="title"></div>
    <div id="button-container" class="button-container"></div>
    <div id="secondary-title" class="secondary-title" style="display: none;"></div>
    <div id="secondary-button-container" class="button-container"></div>

    <script>
        let helixToken = null;
        let channelId = null;
        let clientId = null;
        let viewerInfo = null;
        let tokenReceived = false;
        let authData = null;
        // Инициализация расширения
        window.Twitch.ext.onAuthorized(async (auth) => {
            console.log('Extension authorized:', auth);

            if (!auth) {
                console.error('Authorization data is missing');
                return;
            }
            authData = auth;

            if (auth.channelId && auth.helixToken) {
                try {
                    // Собираем информацию о зрителе
                    viewerInfo = {
                        userId: auth.userId,
                        username: auth.userName || 'anonymous',
                        isBroadcaster: auth.isBroadcaster,
                        isMod: auth.isMod,
                        action: 'viewer_connected',
                        timestamp: new Date().toISOString()
                    };

                    console.log('User JWT for Helix API calls:', auth.helixToken);

                    // Disable automatic configuration before sending
                    //window.Twitch.ext.configuration.set('broadcaster', '', '');

                    // Отправляем информацию о зрителе
                    //window.Twitch.ext.send('broadcast', 'application/json', viewerInfo);

                    if (tokenReceived) {
                        sendViewerInfo();
                    }

                } catch (e) {
                    console.error('Authorization error:', e);
                }
            } else {
                console.error('Authorization failed: missing channelId or helixToken');
            }
        });

        // Обработчик сообщений PubSub
        window.Twitch.ext.listen('broadcast', (target, contentType, message) => {
            console.log('Received PubSub message:', message);
            try {
                if (!message) {
                    throw new Error('Message is undefined');
                }

                const msg = typeof message === 'string' ? JSON.parse(message) : message;

                if (msg.msg_type === 'token' && msg.data) {
                    // Получаем JWT токен для работы с Helix API
                    console.log('Received Helix token');
                    helixToken = msg.data.token;
                    channelId = msg.data.channel_id;
                    clientId = msg.data.client_id;
                    if (viewerInfo) {
                        sendViewerInfo();
                    }
                    return;
                }

                if (msg.type === 'config_update' && msg.data) {
                    console.log('Received new config:', msg.data);
                    updateUI(msg.data);
                }
            } catch (e) {
                console.error('Message parse error:', e);
            }
        });

        / Функция отправки информации о зрителе
        function sendViewerInfo() {
            if (!viewerInfo || !tokenReceived) return;

            try {
                // Отправляем через стандартный механизм
                //window.Twitch.ext.send('broadcast', 'application/json', viewerInfo);

                // И через Helix PubSub
                sendViaHelixPubSub({
                    event: 'viewer_connected',
                    data: viewerInfo
                });

                console.log('Viewer info sent thru Helix PubSub');
            } catch (e) {
                console.error('Error sending viewer info:', e);
            }
        }

        // Новая функция для отправки через Helix PubSub
        async function sendViaHelixPubSub(message) {
            if (!helixToken || !channelId || !clientId) {
                console.error('Helix credentials not available');
                return false;
            }

            try {
                const response = await fetch(
                    "https://api.twitch.tv/helix/extensions/pubsub",
                    {
                        method: "POST",
                        headers: {
                            "Client-ID": clientId,
                            "Authorization": `Bearer ${helixToken}`,
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({
                            target: ["broadcast"], // Отправляем всем подписчикам
                            broadcaster_id: channelId,
                            is_global_broadcast: false,
                            message: JSON.stringify(message)
                        })
                    }
                );

                if (response.status !== 204) {
                    const errorText = await response.text();
                    console.error('Helix PubSub Error:', errorText);
                    return false;
                }

                console.log('Message sent via Helix PubSub');
                return true;
            } catch (err) {
                console.error('Helix PubSub Request Error:', err);
                return false;
            }
        }

        // Обновление UI на основе конфигурации
        function updateUI(config) {
            if (!config) {
                console.error('Config is undefined');
                return;
            }

            // Основной заголовок
            const mainTitle = document.getElementById('main-title');
            if (config.mainTitle && mainTitle) {
                mainTitle.textContent = config.mainTitle;
            }

            // Основные кнопки
            const buttonContainer = document.getElementById('button-container');
            if (buttonContainer) {
                buttonContainer.innerHTML = '';

                if (config.buttons && Array.isArray(config.buttons)) {
                    config.buttons.forEach(button => {
                        if (button.id && button.label) {
                            const btn = document.createElement('button');
                            btn.className = 'button';
                            btn.textContent = button.label;
                            btn.onclick = () => handleButtonClick(button.id);
                            buttonContainer.appendChild(btn);
                        }
                    });
                }
            }

            // Вторичный заголовок
            const secondaryTitle = document.getElementById('secondary-title');
            if (secondaryTitle) {
                if (config.secondaryTitle) {
                    secondaryTitle.textContent = config.secondaryTitle;
                    secondaryTitle.style.display = 'block';
                } else {
                    secondaryTitle.style.display = 'none';
                }
            }

            // Вторичные кнопки
            const secondaryButtonContainer = document.getElementById('secondary-button-container');
            if (secondaryButtonContainer) {
                secondaryButtonContainer.innerHTML = '';

                if (config.secondaryButtons && Array.isArray(config.secondaryButtons)) {
                    config.secondaryButtons.forEach(button => {
                        if (button.id && button.label) {
                            const btn = document.createElement('button');
                            btn.className = 'button';
                            btn.textContent = button.label;
                            btn.onclick = () => handleButtonClick(button.id);
                            secondaryButtonContainer.appendChild(btn);
                        }
                    });
                }
            }
        }

        let lastClickTime = 0;

        // Обработка нажатия кнопки
        function handleButtonClick(buttonId) {
            const now = Date.now();
            if (now - lastClickTime < 500) {
                console.log('Click throttled');
                return;
            }
            lastClickTime = now;

            window.Twitch.ext.onAuthorized(function (auth) {
                if (!auth) {
                    console.error('Authorization failed');
                    return;
                }

                const username = auth.userName || 'anonymous';

                try {
                    if (!buttonId) {
                        throw new Error('Button ID is undefined');
                    }

                    const message = {
                        action: 'button_click',
                        button_id: buttonId,
                        username: username,
                        timestamp: new Date().toISOString(),
                        _customEvent: true
                    };

                    //window.Twitch.ext.configuration.set('broadcaster', '', '');
                    //window.Twitch.ext.send('broadcast', 'application/json', message);

                    //window.Twitch.ext.actions.sendChatMessage(`User ${username} pressed special button!`);

                    if (helixToken) {
                        sendViaHelixPubSub({
                            event: 'button_click',
                            data: message
                        });
                    } else {
                        console.log('Helix token is empty, cannot send click response!');
                    }

                    
                } catch (e) {
                    console.error('Send button click error:', e);
                }

                console.log('Button clicked:', buttonId);
            });
        }

        // Инициализация с дефолтными значениями
        document.addEventListener('DOMContentLoaded', () => {
            updateUI({
                mainTitle: "Extension Overlay",
                buttons: [
                    { id: "btn1", label: "Action 1" },
                    { id: "btn2", label: "Action 2" }
                ],
                secondaryTitle: "More Options",
                secondaryButtons: [
                    { id: "btn3", label: "Special" },
                    { id: "btn4", label: "Help" }
                ]
            });
        });
    </script>
</body>
</html>